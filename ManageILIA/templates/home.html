{% extends 'base1.html' %}
{% load static %}

{% block title %}Accueil{% endblock %}

{% block content %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/fr.global.min.js'></script>

<style>

  /* Conteneur 70/30 */
  .home-container {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  /* Section calendrier 70% */
  .calendar-section {
    flex: 0 0 70%;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
  }

  /* Section utilisateurs 30% */
  .users-section {
    flex: 0 0 30%;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
    max-height: 700px;
    overflow-y: auto;
  }

  /* Titre de la section utilisateurs */
  .users-section h5 {
    color: #1e3c72;
    font-weight: 600;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
    font-size: 1.05rem;
  }

  /* Item utilisateur */
  .user-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.875rem 0.75rem;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
    border-radius: 6px;
  }

  .user-item:last-child {
    border-bottom: none;
  }

  .user-item:hover {
    background-color: #f8f9fa;
  }

  /* Nom de l'utilisateur dans la liste */
  .user-list-name {
    color: #1e3c72;
    font-weight: 500;
    font-size: 0.95rem;
  }

  /* Conteneur du statut */
  .user-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Indicateur de statut (rond) */
  .status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    flex-shrink: 0;
  }

  .status-present {
    background-color: #28a745;
  }

  .status-telework {
    background-color: #ff9800;
  }

  /* Label du statut */
  .status-label {
    font-size: 0.8rem;
    color: #666;
    font-weight: 500;
  }

  /* Styles FullCalendar */
  .fc {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .fc .fc-button-primary {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    border-color: #1e3c72;
    font-weight: 500;
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .fc .fc-button-primary:not(:disabled).fc-button-active {
    background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
    border-color: #1e3c72;
  }

  .fc .fc-button-primary:not(:disabled):hover {
    background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(30, 60, 114, 0.3);
  }

  .fc-event {
    cursor: pointer;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .fc-event:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }

  .fc-daygrid-day:hover {
    background-color: rgba(30, 60, 114, 0.05);
  }

  .fc-toolbar-title {
    color: #1e3c72;
    font-weight: 600;
    font-size: 1.25rem;
  }

  .fc-col-header-cell {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-weight: 600;
    color: #1e3c72;
  }

  .fc-daygrid-day-number {
    color: #1e3c72;
    font-weight: 500;
  }

  #calendar {
    border-radius: 8px;
    overflow: hidden;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .home-container {
      flex-direction: column;
    }

    .calendar-section,
    .users-section {
      flex: 0 0 100%;
    }

    .users-section {
      max-height: none;
    }
  }

  /* Scroll personnalisé */
  .users-section::-webkit-scrollbar {
    width: 6px;
  }

  .users-section::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  .users-section::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }

  .users-section::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>

<div class="home-container">
  <!-- Section Calendrier (70%) -->
  <div class="calendar-section">
    <div id="calendar"></div>
  </div>

  <!-- Section Utilisateurs (30%) -->
  <div class="users-section">
    <h5>Status</h5>
    {% for item in users_status %}
      <div class="user-item">
        <a href="{% url 'accounts:user_profile' item.user_id %}" class="user-list-name" style="text-decoration: none; display: block; width: 100%;">
            {{ item.display_name }}
        </a>
        <div class="user-status">
          <span class="status-indicator {% if item.status == 'present' %}status-present{% else %}status-telework{% endif %}"
                title="{% if item.status == 'present' %}Sur place{% else %}En distanciel{% endif %}"></span>
          <span class="status-label">
            {% if item.status == 'present' %}
               Présent
            {% else %}
               Distanciel
            {% endif %}
          </span>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Modal pour détails d'événement -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 12px; border: 1px solid #e9ecef;">
      <div class="modal-header" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; border: none;">
        <h5 class="modal-title" id="eventDetailModalLabel">Détail de l'événement</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <p class="mb-1 text-muted small" id="eventType"></p>
        <h4 class="mb-3" id="eventTitle" style="color: #1e3c72; font-weight: 600;"></h4>
        <p class="mb-2">
          <strong style="color: #1e3c72;">Quand :</strong>
          <span id="eventDateTime"></span>
        </p>
        <p class="mb-0" id="eventDescriptionWrapper" style="display:none;">
          <strong style="color: #1e3c72;">Description :</strong><br>
          <span id="eventDescription" class="text-muted"></span>
        </p>
      </div>
      <div class="modal-footer" style="border-top: 1px solid #e9ecef;">
        <button type="button" class="btn btn-outline-secondary btn-sm" style="border-radius: 6px;" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar;
    var eventModal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
    var modalTitle = document.getElementById('eventTitle');
    var modalType = document.getElementById('eventType');
    var modalDateTime = document.getElementById('eventDateTime');
    var modalDescWrapper = document.getElementById('eventDescriptionWrapper');
    var modalDesc = document.getElementById('eventDescription');

    function getColor(type) {
      var colors = {
        'personal': { bg: '#4e85cd', border: '#0a738a' },
        'telework': { bg: '#FF6B6B', border: '#C92A2A' },
        'event': { bg: '#20c997', border: '#099268' },
        'reservation': { bg: '#ffc107', border: '#e0a800' }
      };
      return colors[type] || { bg: '#95E1D3', border: '#4e85cd' };
    }

    calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      firstDay: 1,
      businessHours: {
        daysOfWeek: [1, 2, 3, 4, 5, 6, 7],
        startTime: '07:00',
        endTime: '21:00'
      },
      slotMinTime: '07:00',
      slotMaxTime: '23:00',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
        buttonText: {
			today: "Aujourd'hui",
			month: 'Mois',
			week: 'Semaine',
			day: 'Jour'
		},
      locale: 'fr',
      events: function(info, successCallback, failureCallback) {
        const url = `{% url 'personal_schedule' %}?start=${info.startStr}&end=${info.endStr}&format=json`;
        const eventsUrl = `{% url 'get_events_and_reservations' %}?start=${info.startStr}&end=${info.endStr}`;

        Promise.all([
          fetch(url).then(r => r.ok ? r.json() : Promise.reject('Error loading personal schedule')),
          fetch(eventsUrl).then(r => r.ok ? r.json() : Promise.reject('Error loading events/reservations'))
        ])
        .then(([personalData, externalData]) => {
          var events = [];

          // Événements personnels
          if (personalData.entries && Array.isArray(personalData.entries)) {
            personalData.entries.forEach(function(entry) {
              events.push({
                title: entry.title,
                start: entry.start_datetime,
                end: entry.end_datetime,
                backgroundColor: getColor('personal').bg,
                borderColor: getColor('personal').border,
                extendedProps: {
                  type: 'personal',
                  label: 'Événement personnel',
                  description: entry.description
                }
              });
            });
          }

          // Télétravail récurrent
          if (personalData.recurring_teleworks && Array.isArray(personalData.recurring_teleworks)) {
            personalData.recurring_teleworks.forEach(function(telework) {
              var startDateObj = new Date(telework.start_date + 'T00:00:00');
              var endDateObj = new Date(telework.end_date + 'T00:00:00');

              for (var d = new Date(startDateObj); d <= endDateObj; d.setDate(d.getDate() + 1)) {
                if (d.getDay() === (telework.day_of_week + 1) % 7) {
                  var year = d.getFullYear();
                  var month = String(d.getMonth() + 1).padStart(2, '0');
                  var day = String(d.getDate()).padStart(2, '0');
                  var dateStr = year + '-' + month + '-' + day;

                  events.push({
                    title: 'Télétravail',
                    start: dateStr,
                    end: dateStr,
                    allDay: true,
                    backgroundColor: getColor('telework').bg,
                    borderColor: getColor('telework').border,
                    extendedProps: {
                      type: 'telework',
                      label: 'Télétravail'
                    }
                  });
                }
              }
            });
          }

          // Événements (acceptés)
          if (externalData.events && Array.isArray(externalData.events)) {
            externalData.events.forEach(function(event) {
              events.push({
                title: event.title,
                start: event.start,
                end: event.end,
                backgroundColor: getColor('event').bg,
                borderColor: getColor('event').border,
                extendedProps: {
                  type: 'event',
                  label: `Événement (${event.organiser_name})`,
                  description: event.description
                }
              });
            });
          }

          // Réservations
          if (externalData.reservations && Array.isArray(externalData.reservations)) {
                externalData.reservations.forEach(function(reservation) {
                  events.push({
                    title: reservation.title,
                    start: reservation.start,
                    end: reservation.end,
                    backgroundColor: getColor('reservation').bg,
                    borderColor: getColor('reservation').border,
                    extendedProps: {
                      type: 'reservation',
                      label: `Réservation (${reservation.creator_name})`,
                      description: reservation.description,
                      bureau_name: reservation.bureau_name,
                      piece_name: reservation.piece_name
                    }
                  });
                });
              }

          successCallback(events);
        })
        .catch(error => {
          console.error('Erreur:', error);
          failureCallback(error);
        });
      },
      eventClick: function(info) {
        modalType.textContent = info.event.extendedProps.label || info.event.extendedProps.type || 'Événement';
        modalTitle.textContent = info.event.title;
        const start = info.event.start ? new Date(info.event.start).toLocaleString('fr-FR') : 'Non défini';
        const end = info.event.end ? new Date(info.event.end).toLocaleString('fr-FR') : 'Non défini';
        modalDateTime.textContent = `${start} → ${end}`;

        if (info.event.extendedProps.description) {
          modalDesc.textContent = info.event.extendedProps.description;
          modalDescWrapper.style.display = 'block';
        } else {
          modalDescWrapper.style.display = 'none';
        }

        eventModal.show();
      }
    });

    calendar.render();
  });
</script>
{% endblock %}